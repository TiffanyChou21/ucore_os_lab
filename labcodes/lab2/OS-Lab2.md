# ucoreOSæ“ä½œç³»ç»Ÿå®éªŒâ€”â€”Lab2  

>  åæ§½è¸©å‘

- ç”±äºä»¥å‰ç›´æ¥mergeè¸©è¿‡å·¨å¤§çš„å‘æ‰€ä»¥é€‰æ‹©äº†æ‰‹åŠ¨mergeï¼Œä½†æ˜¯ç”±äºæ²¡ä»”ç»†çœ‹init.cæ‰€ä»¥æ²¡æœ‰lab1ç»ƒä¹ å…­è¾“å‡ºçš„æ—¶å€™æ„Ÿè§‰å¾ˆå¥‡æ€ªå°±ä¸‹äº†meldæŸ¥çœ‹å¯¹æ¯”ï¼Œå‘ç°å¥½åƒå¹¶æ²¡æœ‰å‡ºé”™ï¼Œäºæ˜¯æ‰¾äº†åŠå¤©åŸå› ï¼Œç›´åˆ°æƒ³èµ·æ¥å»çœ‹ä¸€çœ¼init.cæ‰å‘ç°idt_initæ‰§è¡Œæ˜¯åœ¨pmm_initä¹‹åçš„ï¼Œè€Œpmmå¹¶æ²¡æœ‰å®Œæˆæ‰€ä»¥è‚¯å®šä¸ä¼šæœ‰ç»“æœã€‚å…¶å®ä¹Ÿç®—ä¸ä¸Šå‘ï¼Œåº”è¯¥ç®—æ˜¯é•¿äº†ä¸€ä¸ªæ•™è®­ï¼Œåº”è¯¥å®Œæ•´çœ‹å®Œå®éªŒå†…å®¹ä¸ç„¶ä¸œå¢™è¡¥å®Œè¡¥è¥¿å¢™æ˜¯ä¸èƒ½é•¿ä¹…çš„ï¼Œä»¥ååº”è¯¥å†æ·±å…¥ç ”ç©¶ä¸€ä¸‹diff mergeè¿™äº›ä¼˜ç§€çš„å·¥å…·ï¼Œæ¯•ç«Ÿæ‰‹åŠ¨å‡ºé”™æ¦‚ç‡é«˜

- ä¸€å¼€å§‹çœ‹å®Œæ³¨é‡Šè¿˜æ˜¯æ‡µçš„ï¼Œè·Ÿlab1è¯¦ç»†åˆ°æ¯ä¸€è¡Œä»£ç çš„æ³¨é‡Šä¸ä¸€æ ·ï¼Œlab2æœ‰ä¸€å¤§ç¯‡çš„å…¨é¢ä»‹ç»ï¼Œä¹‹åå°±æ˜¯é è‡ªå·±ä¼˜åŒ–first-fitç®—æ³•äº†ï¼Œè™½ç„¶æ³¨é‡Šå¾ˆè¯¦å°½å…¨é¢ä½†è¿˜æ˜¯ä¸çŸ¥é“first-fitåœ¨å¹²å˜›ï¼Œæ‰€ä»¥æ‰¾åˆ°äº†mooc5.3è¿ç»­å†…å­˜åˆ†é…ä¸­å¯¹ä¸‰ç§ç®—æ³•çš„ä»‹ç»ï¼Œæ€»ç®—æœ€åæ‘¸åˆ°ä¸€ç‚¹å¤´è„‘ï¼Œè€Œä¸”lab2çš„ä»£ç ä¹ä¸€çœ‹å·²ç»æŒºå®Œå–„çš„äº†ï¼Œä½†ä»”ç»†ç»“åˆå®éªŒæŠ¥å‘Šçš„è¦æ±‚ä¸€çœ‹å…¶å®ä¸ç¬¦åˆå®éªŒè¦æ±‚ï¼Œæœ‰çš„æ˜¯æ¡ä»¶æœ‰é—®é¢˜ï¼Œæœ‰çš„æ˜¯æ€è·¯ä¸ä¸€è‡´ç­‰å¾…

- ç»ƒä¹ äºŒå’Œä¸‰å°±æ›´æ˜¯ä¸€å¤´é›¾æ°´äº†ï¼Œå¯èƒ½è·Ÿç†è®ºè¯¾è¿˜æ²¡æœ‰å°†ç›¸å…³å†…å®¹ä»¥åŠè®¡ç»„å…¨å¿˜äº†æœ‰å…³ï¼Œæ‰€ä»¥ç€é‡çœ‹äº†å®éªŒæŒ‡å¯¼ä¹¦é™„å½•å†…å®¹å’Œmooc6.3-4ä»¥åŠ8.4-6ï¼Œå†æ ¹æ®get_pteå’Œpage_remove_pteçš„æ‰§è¡Œé¡ºåºä»¥åŠç›¸å…³æ³¨é‡Šé€å¥ç¿»è¯‘æ³¨é‡Šå¹¶ç†è§£ç¨‹åºè¿™ä¹ˆå»å†™çš„æ„å›¾å°±ä¼šç†è§£çš„å¾ˆå¥½(ä½†å…¶å®get_pteéƒ½æ²¡çœ‹æ‡‚æ˜¯åœ¨å¹²å˜›ï¼Œå‚è€ƒäº†å„ç§Githubå¤§ä½¬çš„æŠ¥å‘Šä»¥åŠå¥½å¤šéçš„MOOCæ‰getåˆ°ï¼Œä¸è¿‡ä¹Ÿè·Ÿæˆ‘æå‰å†™äº†è¿™æ¬¡ä½œä¸šæœ‰å…³(å†…å­˜ä»€ä¹ˆçš„è¿˜æ²¡æ€ä¹ˆè®²))ç°åœ¨å¥½äº†ï¼Œè®²å®Œäº†å†çœ‹å¥½åƒå°±æ²¡é‚£ä¹ˆéš¾äº†

- åŸºæœ¬å®ç°äº†å®éªŒè¦æ±‚çš„æ‰€æœ‰ç»ƒä¹ ä»¥åä½¿ç”¨`make grade`å‡ºæ»¡åˆ†ä»¥åï¼Œæ»¡å¿ƒæ¬¢å–œçš„ä»¥ä¸ºé¡ºåˆ©å®Œæˆäº†å®éªŒï¼Œç»“æœ`make qemu`ä¹‹åå‡ºç°äº†å¦‚ä¸‹ç»“æœ

  ![lab2-11](file:///Users/zhouchenfei/Desktop/OS%E6%88%AA%E5%9B%BE/lab2-11.png?lastModify=1572702691)

  terminalå‘Šè¯‰æˆ‘äº†æŠ¥é”™åŸå› å’Œä½ç½®ï¼Œè¿™å…¶å®æ˜¯ä¸€ä¸ªæœ¬èº«å°±ç”¨çš„éªŒè¯æœºåˆ¶ï¼ŒæŒ‰ç†è¯´ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œè€Œä¸”æ›´å¥‡æ€ªçš„æ˜¯å°±åœ¨è¿™ä¸ªassertä¸ºç©ºä¹‹å‰æ‰æœ‰ä»£ç å®šä¹‰äº†å°†ä¹‹è®¾ä¸ºNULLï¼Œæ‰€ä»¥æ˜¯çœŸçš„ä¸çŸ¥é“æ˜¯å‡ºäº†ä»€ä¹ˆæ•…éšœï¼Œæ‰€ä»¥åˆæ¢ubuntuè·‘äº†ä¸€éï¼Œå‘ç°æŠ¥é”™çš„åŸå› åˆè·‘åˆ°äº†pmm_initçš„ä¸‹ä¸€ä¸ªå‡½æ•°ï¼Œäºæ˜¯é€šè¿‡gdbå•æ­¥è°ƒè¯•æ‰¾åˆ°äº†é—®é¢˜ï¼Œæ˜¯ä¿å­˜æ–‡ä»¶çš„æ—¶å€™å‡ºç°äº†æ•…éšœï¼ŒåŸæœ¬åº”è¯¥ä¿å­˜çš„`make grade`åæ­£ç¡®çš„ç‰ˆæœ¬å¹¶æ²¡æœ‰ä¿å­˜ï¼Œä¿ç•™çš„æ˜¯å°†`struct Page *p = le2page(le, page_link);`è¿™ä¸€ç®€å•åˆå§‹åŒ–ç›´æ¥å†™æˆNULLçš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥åœ¨åç»­çš„assertä¸­æ‰ä¼šå‡ºç°éªŒè¯ä¸ºNULLçš„æƒ…å†µï¼Œæ‰€ä»¥åˆä»Macæ¢å›äº†ubuntu(å¤ªèœäº†ä¸é…ä½¿ç”¨Mac)

## ç»ƒä¹ 0

> æœ¬å®éªŒä¾èµ–å®éªŒ1ã€‚è¯·æŠŠä½ åšçš„å®éªŒ1çš„ä»£ç å¡«å…¥æœ¬å®éªŒä¸­ä»£ç ä¸­æœ‰â€œLAB1â€çš„æ³¨é‡Šç›¸åº”éƒ¨åˆ†ã€‚æç¤ºï¼šå¯é‡‡ç”¨diffå’Œpatchå·¥å…·è¿›è¡ŒåŠè‡ªåŠ¨çš„åˆå¹¶ï¼ˆmergeï¼‰ï¼Œä¹Ÿå¯ç”¨ä¸€äº›å›¾å½¢åŒ–çš„æ¯”è¾ƒ/mergeå·¥å…·æ¥æ‰‹åŠ¨åˆå¹¶ï¼Œæ¯”å¦‚meldï¼Œeclipseä¸­çš„diff/mergeå·¥å…·ï¼Œunderstandä¸­çš„diff/mergeå·¥å…·ç­‰

â€‹	æ‰‹åŠ¨å¤åˆ¶mergeï¼Œç”±äºpmm_init()å°šæœªå®Œæˆæ‰€ä»¥ç»ƒä¹ å…­ç»“æœæ²¡æœ‰è¾“å‡ºï¼Œç­‰æ‰€æœ‰ä»£ç éƒ½è¾“å‡ºä»¥åå³å¯çœ‹åˆ°ç»ƒä¹ å…­è¾“å‡ºï¼Œmergeä»¥åæŸ¥çœ‹ç»“æœï¼Œå‘ç°å…¶å®lab2å¹¶ä¸ä»…ä»…æ˜¯æ‹·è´äº†lab1çš„æˆæœï¼Œæ¯”å¦‚åœ¨bootloaderæ‰§è¡Œkern_initä¹‹å‰lab2ä¼šå…ˆè¡Œè°ƒç”¨entry.Sä¸­çš„kern_entryï¼Œå®ƒä¸ºæ‰§è¡Œkern_initè®¾ç½®å †æ ˆï¼Œè€Œä¸”ä¸´æ—¶å»ºç«‹äº†ä¸€ä¸ªæ®µæ˜ å°„å…³ç³»ï¼Œè¿™äº›éƒ½ä¸ºä¹‹åå»ºç«‹åˆ†é¡µæœºåˆ¶çš„è¿‡ç¨‹åšä¸€ä¸ªå‡†å¤‡ï¼Œå®Œæˆè¿™äº›ä¹‹åï¼Œæ‰è°ƒç”¨kern_initã€‚

##  ç»ƒä¹ ä¸€

> **å®ç° first-fit è¿ç»­ç‰©ç†å†…å­˜åˆ†é…ç®—æ³•ï¼ˆéœ€è¦ç¼–ç¨‹ï¼‰**
>
> åœ¨å®ç°first fit å†…å­˜åˆ†é…ç®—æ³•çš„å›æ”¶å‡½æ•°æ—¶ï¼Œè¦è€ƒè™‘åœ°å€è¿ç»­çš„ç©ºé—²å—ä¹‹é—´çš„åˆå¹¶æ“ä½œã€‚æç¤º:åœ¨å»ºç«‹ç©ºé—²é¡µå—é“¾è¡¨æ—¶ï¼Œéœ€è¦æŒ‰ç…§ç©ºé—²é¡µå—èµ·å§‹åœ°å€æ¥æ’åºï¼Œå½¢æˆä¸€ä¸ªæœ‰åºçš„é“¾è¡¨ã€‚å¯èƒ½ä¼šä¿®æ”¹default_pmm.cä¸­çš„default_initï¼Œdefault_init_memmapï¼Œdefault_alloc_pagesï¼Œ default_free_pagesç­‰ç›¸å…³å‡½æ•°ã€‚è¯·ä»”ç»†æŸ¥çœ‹å’Œç†è§£default_pmm.cä¸­çš„æ³¨é‡Š

â€‹	é˜…è¯»default_pmm.cä¸­çš„æ³¨é‡Šï¼Œéœ€è¦æ”¹å†™default_initï¼Œdefault_init_memmapï¼Œdefault_alloc_pages, default_free_pageså‡ ä¸ªå‡½æ•°

â€‹	æŸ¥çœ‹FFMAç®—æ³•éƒ¨åˆ†æ³¨é‡Šå°†ä»£ç åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

#### Prepare

â€‹	äº†è§£list.hä¸­çš„*list_entry*ç»“æ„å¹¶ä¸”ä¼šä½¿ç”¨ä¸è¯¥ç»“æ„ç›¸å…³çš„å‡½æ•°

```c
//list.h
struct list_entry {//ä¸€ä¸ªç®€å•çš„åŒé“¾è¡¨
    struct list_entry *prev, *next;//ä¸¤ä¸ªæŒ‡é’ˆçˆ¶å­èŠ‚ç‚¹
};
typedef struct list_entry list_entry_t;//é‡å‘½å
list_init() //åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„list_entry
list_add(),list_add_after(),list_add_after()//æ·»åŠ ä¸€ä¸ªæ–°çš„è¡¨é¡¹
list_del()//ä»è¡¨ä¸­åˆ é™¤ä¸€ä¸ªè¡¨é¡¹
list_del_init()//ä»è¡¨ä¸­åˆ é™¤å¹¶é‡å®šä¹‰ä¸€ä¸ªè¡¨é¡¹
list_empty()//åˆ¤æ–­é“¾è¡¨æ˜¯å¦ä¸ºç©º
list_next()list_prev()//è·å–é“¾è¡¨çš„å‰ä¸€é¡¹å’Œåä¸€é¡¹
```

â€‹	å¦ä¸€ç§å¤æ‚çš„åŠæ³•æ˜¯å°†åŒå‘é“¾è¡¨ç»“æ„è½¬åŒ–ä¸ºé¡µï¼Œæœ‰ç›¸å…³å®le2pageåœ¨memlayout.hä¸­

```c
//memlayout.h
struct Page {//Pageç»“æ„å®šä¹‰
    int ref;        // page frame's reference counter
    uint32_t flags; // array of flags that describe the status of the page frame
    unsigned int property;// the num of free block, used in first fit pm manager
    list_entry_t page_link;// free list link
};
// le2pageå®å®šä¹‰
#define le2page(le, member) to_struct((le), struct Page, member)
```

#### default_init

â€‹	è¯¥å‡½æ•°å¯è¢«ç›´æ¥ä½¿ç”¨ï¼Œç”¨ä»¥åˆå§‹åŒ–free_listå’Œå°†nr_freeç½®0

â€‹	åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„åŒå‘é“¾è¡¨

<img src="/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-1.png" alt="lab2-1" style="zoom:40%;" />

â€‹	free_area_tç»“æ„å®šä¹‰åœ¨memlayout.hä¸­

<img src="/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-2.png" alt="lab2-2" style="zoom: 40%;" />

#### default_init_memmap

1. é¦–å…ˆåˆå§‹åŒ–æ¯ä¸ªåœ¨memelayout.hä¸­å®šä¹‰çš„page(ç‰©ç†é¡µ)ï¼Œå°†å…¨éƒ¨çš„å¯åˆ†é…ç‰©ç†é¡µè§†ä¸ºä¸€å¤§å—ç©ºé—²å—åŠ å…¥ç©ºé—²è¡¨ã€‚
   - pâ†’flagsåº”è¢«ç½®ä¸ºPG_property(è¡¨ç¤ºæ˜¯ä¸€ä¸ªæœ‰è¿ç»­åœ°å€ä¸”å¯ä»¥è¢«åˆ†é…çš„ç©ºé—²å—çš„é¦–é¡µ)ï¼Œä½¿ç”¨p->page_linkå°†é¡µé“¾æ¥åˆ°free_listé‡Œé¢ï¼Œæœ€åæ›´æ­£nr_freeçš„æ•°ç›®
   - æ ¹æ®æ³¨é‡Šæç¤ºå°†default_init_memmapæ”¹å†™æˆå¦‚ä¸‹ï¼š

<img src="/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-3.png" alt="lab2-3" style="zoom:50%;" />

(è™½ç„¶å†™äº†å¥½å¤šï¼Œä½†å…¶å®åªæ”¹äº†æœ€åä¸€å¥ï¼ŒåŒå‘é“¾è¡¨ï¼Œæ‰€ä»¥å¤´æŒ‡é’ˆçš„å‰ä¸€ä¸ªå°±æ˜¯æœ€åä¸€ä¸ª)

#### default_alloc_pages

â€‹	è¯¥å‡½æ•°ä½œç”¨æ˜¯åœ¨free listä¸­æ‰¾åˆ°ä¸€ä¸ªå¤§å°â‰¥nçš„å—é‡æ–°åˆ†é…å…¶å¤§å°å¹¶è¿”å›è¿™ä¸ªåˆ†é…åçš„å—åœ°å€(first fitæ˜¯æŒ‰ç…§åœ°å€ä»å°åˆ°å¤§æ£€ç´¢)

â€‹	<img src="/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-4.png" alt="lab2-4" style="zoom:40%;" />

â€‹		ä»£ç æœ‰æ‰€å˜åŠ¨çš„åœ°æ–¹åœ¨äºæ£€æŸ¥ä¸ä¸ºç©ºåï¼Œæ ¹æ®æ³¨é‡Šåˆ¤æ–­pâ†’propertyçš„å¤§å°ï¼Œâ‰¥nè¦å¯¹ä¸¤ä¸ªæ ‡å¿—ä½ä¿®æ”¹å¹¶ä¸”ï¼nçš„è¦å°†å—åˆ†éš”ï¼Œå¦‚æœä¸ç¬¦åˆåˆ™è¦è¿”å›NULL

#### default_free_pages

â€‹	è¯¥å‡½æ•°é‡æ–°å°†é¡µé“¾æ¥åˆ°free list(ç›¸é‚»çš„åˆå¹¶)ï¼Œä¹Ÿå¯ä»¥æ˜¯å°†å°çš„ç©ºå—åˆå¹¶åˆ°å¤§å—ä¸­

<img src="/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-5.png" alt="lab2-5" style="zoom:50%;" />

â€‹	ä»£ç åŸºæœ¬éƒ½åšäº†æ”¹åŠ¨ï¼Œä¸»è¦æ˜¯åˆå¹¶éƒ¨åˆ†çš„åˆ¤æ–­å’Œæ“ä½œï¼Œå› ä¸ºåŸä»£ç æ˜¯ä»å¤´æ‰¾åˆ°å°¾ï¼Œæ‰¾æ˜¯å¦æœ‰freeå—ç›¸é‚»çš„å—ï¼Œä½†å…¶å®æ ¹æ®first fitï¼Œåªè¦ç…§ç€ç¬¬ä¸€ä¸ªåˆ¤æ–­å‡ºæ¥ç„¶ååˆå¹¶å°±å¯ä»¥äº†

#### å›ç­”é—®é¢˜

â€‹	å®éªŒä¸­çš„first-fitç®—æ³•ä½¿ç”¨é“¾è¡¨è¿›è¡ŒæŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(N)ï¼Œå¯ä»¥ä½¿ç”¨æ ‘çŠ¶ç»“æ„ï¼Œå°½ç®¡allocçš„è¿‡ç¨‹å˜æˆDFSåå¤æ‚åº¦ä»ç„¶æ˜¯O(N)ï¼Œä½†freeè¿‡ç¨‹å¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œå¤æ‚åº¦ä¸ºO(logn)ï¼Œæ­¤å¤–è¿˜å¯ä»¥ä½¿ç”¨mooc5.3ä¸­çš„best-fitå’Œworst-fitç®—æ³•

## ç»ƒä¹ äºŒ

> **å®ç°å¯»æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„é¡µè¡¨é¡¹ï¼ˆéœ€è¦ç¼–ç¨‹ï¼‰**
>
> é€šè¿‡è®¾ç½®é¡µè¡¨å’Œå¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œå¯å»ºç«‹è™šæ‹Ÿå†…å­˜åœ°å€å’Œç‰©ç†å†…å­˜åœ°å€çš„å¯¹åº”å…³ç³»ã€‚å…¶ä¸­çš„get_pteå‡½æ•°æ˜¯è®¾ç½®é¡µè¡¨é¡¹ç¯èŠ‚ä¸­çš„ä¸€ä¸ªé‡è¦æ­¥éª¤ã€‚æ­¤å‡½æ•°æ‰¾åˆ°ä¸€ä¸ªè™šåœ°å€å¯¹åº”çš„äºŒçº§é¡µè¡¨é¡¹çš„å†…æ ¸è™šåœ°å€ï¼Œå¦‚æœæ­¤äºŒçº§é¡µè¡¨é¡¹ä¸å­˜åœ¨ï¼Œåˆ™åˆ†é…ä¸€ä¸ªåŒ…å«æ­¤é¡¹çš„äºŒçº§é¡µè¡¨ã€‚æœ¬ç»ƒä¹ éœ€è¦è¡¥å…¨get_pteå‡½æ•° in kern/mm/pmm.cï¼Œå®ç°å…¶åŠŸèƒ½ã€‚

â€‹	å€ŸåŠ©mooc8.5è™šæ‹Ÿé¡µå¼å­˜å‚¨ä»¥åŠå®éªŒé™„å½•ï¼Œç†æ¸…get_pteå‡½æ•°çš„è°ƒç”¨åŠåŠŸèƒ½ï¼Œå†å€ŸåŠ©æ³¨é‡Šå®Œæˆç¼–ç¨‹

â€‹	é˜…è¯»æ³¨é‡Šç»™å‡ºçš„å®åŠå…¶å®šä¹‰

```c
//å® OR å‡½æ•°
PDX(la) // è¿”å›è™šæ‹Ÿåœ°å€laçš„é¡µç›®å½•ç´¢å¼• /kern/mm/mmu.h
KADDR(pa) //è¿”å›ç‰©ç†åœ°å€paå¯¹åº”çš„è™šæ‹Ÿåœ°å€ /kern/mm/pmm.h
set_page_ref(page,1) //è®¾ç½®æ­¤é¡µè¢«å¼•ç”¨ä¸€æ¬¡  /kern/mm/pmm.h
page2pa(page) //å¾—åˆ°pageç®¡ç†çš„é‚£ä¸€é¡µçš„ç‰©ç†åœ°å€  /kern/mm/pmm.h
struct Page * alloc_page()  //åˆ†é…ä¸€é¡µå‡ºæ¥ /kern/mm/pmm.h
memset(void * s, char c, size_t n)   //è®¾ç½®sæŒ‡å‘åœ°å€çš„å‰é¢nä¸ªå­—èŠ‚ä¸ºâ€˜câ€™
//define
PTE_P 0x001 //è¡¨ç¤ºç‰©ç†å†…å­˜é¡µå­˜åœ¨
PTE_W 0x002 //è¡¨ç¤ºç‰©ç†å†…å­˜é¡µå†…å®¹å¯å†™
PTE_U 0x004 //è¡¨ç¤ºå¯ä»¥è¯»å–å¯¹åº”åœ°å€çš„ç‰©ç†å†…å­˜é¡µå†…å®¹
```

â€‹	å¯ä»¥çœ‹åˆ°mmu.hä¸­æ³¨é‡Šå¦‚ä¸‹

<img src="/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-6.png" alt="lab2-6" style="zoom:40%;" />

â€‹	è¡¨ç¤ºé¡µå¼ç®¡ç†å°†32ä½çš„çº¿æ€§åœ°å€æ‹†åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šDirectoryã€Tableå’ŒOffsetï¼Œucoreé¡µå¼ç®¡ç†é€šè¿‡ä¸€ä¸ªäºŒçº§çš„é¡µè¡¨å®ç°ã€‚ä¸€çº§é¡µè¡¨å­˜æ”¾åœ¨é«˜10ä½ä¸­ï¼ŒäºŒçº§é¡µè¡¨å­˜æ”¾äºä¸­é—´10ä½ä¸­ï¼Œæœ€åçš„12ä½è¡¨ç¤ºåç§»é‡ï¼Œæ®æ­¤å¯ä»¥è¯æ˜ï¼Œé¡µå¤§å°ä¸º4KBï¼ˆ2çš„12æ¬¡æ–¹ï¼Œ4096ï¼‰

â€‹	Directoryä¸ºä¸€çº§é¡µè¡¨ï¼Œ`PDX(la)`å¯ä»¥è·å–Directoryå¯¹åº”è™šæ‹Ÿåœ°å€laçš„ç´¢å¼•ï¼›Tableä¸ºäºŒçº§é¡µè¡¨ï¼Œ`PTX(la)`å¯ä»¥è·å–Tableå¯¹åº”è™šæ‹Ÿåœ°å€çš„ç´¢å¼•

â€‹	å¯»æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„é¡µè¡¨é¡¹çš„ä¸»è¦æ­¥éª¤ï¼š

â€‹	â‘ åœ¨Directoryé‡Œæ‰¾ï¼Œå­˜åœ¨å³ç›´æ¥è¿”å›ï¼›ä¸å­˜åœ¨ä¸”createä¸º0åˆ™è¿”å›NULL

â€‹	â‘¡æˆåŠŸè·å¾—ä¸€ä¸ªpageï¼Œæ¸…ç©ºï¼Œå¹¶æŠŠå¼•ç”¨æ¬¡æ•°+1(è®¾ç½®ä¸º1)ï¼Œå¹¶åœ¨Directoryä¸­å»ºç«‹è¯¥é¡¹å¹¶è¿”å›

â€‹	get_pteçš„åŠŸèƒ½æ˜¯æ ¹æ®åŸºå€è¿”å›pteè™šæ‹Ÿçº¿æ€§åœ°å€ï¼Œå¦‚æœpteä¸å­˜åœ¨å°±åˆ†é…é¡µï¼Œå®ç°å¦‚ä¸‹

<img src="/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-7.png" alt="lab2-7" style="zoom:33%;" />

â€‹	å¾—åˆ°æœ€åreturnçš„pteè™šæ‹Ÿçº¿æ€§åœ°å€çš„è¿‡ç¨‹ä¸ºæ‰¾åˆ°Directoryå¯¹åº”é¡¹ä¸­çš„Tableåœ°å€ï¼Œè½¬ä¸ºè™šæ‹Ÿåœ°å€ï¼Œå†æ ¹æ®çº¿æ€§åœ°å€çš„offsetæ‰¾åˆ°å¯¹åº”é¡µè¡¨

#### å›ç­”é—®é¢˜

> - è¯·æè¿°é¡µç›®å½•é¡¹ï¼ˆPage Directory Entryï¼‰å’Œé¡µè¡¨é¡¹ï¼ˆPage Table Entryï¼‰ä¸­æ¯ä¸ªç»„æˆéƒ¨åˆ†çš„å«ä¹‰ä»¥åŠå¯¹ucoreè€Œè¨€çš„æ½œåœ¨ç”¨å¤„ã€‚
> - å¦‚æœucoreæ‰§è¡Œè¿‡ç¨‹ä¸­è®¿é—®å†…å­˜ï¼Œå‡ºç°äº†é¡µè®¿é—®å¼‚å¸¸ï¼Œè¯·é—®ç¡¬ä»¶è¦åšå“ªäº›äº‹æƒ…ï¼Ÿ

1. <img src="/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-8.png" alt="lab2-8" style="zoom:30%;" />

| ç»„æˆéƒ¨åˆ†  | å«ä¹‰                                       | åœ°å€  |
| --------- | ------------------------------------------ | ----- |
| PTE_P     | è¡¨ç¤ºç‰©ç†å†…å­˜é¡µæ˜¯å¦å­˜åœ¨                     | 0     |
| PTE_W     | è¡¨ç¤ºç‰©ç†å†…å­˜é¡µæ˜¯å¦å¯å†™                     | 1     |
| PTE_U     | è¡¨ç¤ºç‰©ç†å†…å­˜é¡µæ˜¯å¦å¯è¢«ç”¨æˆ·è·å–(éœ€è¦ç‰¹æƒçº§) | 2     |
| PTE_PWT   | è¡¨ç¤ºç‰©ç†å†…å­˜é¡µæ˜¯å¦ç›´å†™(write-through)      | 3     |
| PTE_PCD   | ç¦ç”¨ç¼“å­˜                                   | 4     |
| PTE_A     | è¡¨ç¤ºç‰©ç†å†…å­˜é¡µæ˜¯å¦è¢«ä½¿ç”¨è¿‡                 | 5     |
| PTE_D     | è„é¡µ                                       | 6     |
| PTE_PS    | è®¾ç½®ç‰©ç†å†…å­˜é¡µçš„å¤§å°                       | 7     |
| PTE_MBZ   | must be zeroæ’ä¸º0                          | 8     |
| PTE_AVAIL | å¯ä»¥ç»™OSè®¾ç½®å’Œä½¿ç”¨                         | 11    |
|           | é«˜20ä½                                     | 12-31 |

â€‹	PDEå’ŒPTEçš„é«˜20ä½ç±»ä¼¼ï¼Œéƒ½æ˜¯ç”¨æ¥è¡¨ç¤ºå…¶æŒ‡å‘çš„ç‰©ç†é¡µçš„ç‰©ç†åœ°å€ï¼Œ0-9ä½å¦‚ä¸Šï¼Œå…¶ä¸­9-11ä½ä¿ç•™ç»™OSï¼ŒPDEå’ŒPTEçš„ä¸åŒåœ¨äºï¼šâ‘ PDEçš„ç¬¬7ä½ç”¨äºè®¾ç½®pageå¤§å°0è¡¨ç¤º4KBï¼Œè€ŒPTEçš„ç¬¬7ä½æ’ä¸º0ï¼›â‘¡PDEç¬¬6ä½æ’ä¸º0ï¼ŒPTEç¬¬6ä½è¡¨ç¤ºè„ä½å³æ˜¯å¦éœ€è¦åœ¨swap outçš„æ—¶å€™å†™å›å¤–å­˜ï¼›â‘¢PDEçš„ç¬¬3ä½å¦‚ä¸Šç¬¬4ä½è®¾ç½®ä¸º1åˆ™è¡¨ç¤ºä¸å¯¹è¯¥é¡µè¿›è¡Œç¼“å­˜ï¼ŒPTEçš„3-4ä½æ’ä¸º0ï¼›

â€‹	å¯ä»¥å‘ç°æ— è®ºæ˜¯PTEè¿˜æ˜¯TDEï¼Œéƒ½å…·æœ‰ç€ä¸€äº›ä¿ç•™çš„ä½ä¾›OSä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ucoreå¯ä»¥åˆ©ç”¨è¿™äº›ä½æ¥å®Œæˆä¸€äº›å…¶ä»–çš„å†…å­˜ç®¡ç†ç›¸å…³çš„ç®—æ³•ï¼Œæ¯”å¦‚å¯ä»¥åœ¨è¿™äº›ä½é‡Œä¿å­˜æœ€è¿‘ä¸€æ®µæ—¶é—´å†…è¯¥é¡µçš„è¢«è®¿é—®çš„æ¬¡æ•°ï¼ˆä»…èƒ½è¡¨ç¤º0-7æ¬¡ï¼‰ï¼Œè¿™äº›ä¿ç•™ä½æœ‰åˆ©äºOSè¿›è¡ŒåŠŸèƒ½çš„æ‹“å±•

2.  ç¡¬ä»¶éœ€è¦å®Œæˆï¼š
   - å°†å¼•å‘é¡µè®¿é—®å¼‚å¸¸çš„çº¿æ€§åœ°å€ä¿å­˜åœ¨cr2å¯„å­˜å™¨ä¸­
   - åœ¨ä¸­æ–­æ ˆä¸­ä¾æ¬¡å‹å…¥EFLAGSï¼ŒCS, EIPï¼Œä»¥åŠé¡µè®¿é—®å¼‚å¸¸ç error codeï¼Œå¦‚æœpage faultæ˜¯å‘ç”Ÿåœ¨ç”¨æˆ·æ€ï¼Œåˆ™è¿˜éœ€è¦å…ˆå‹å…¥sså’Œespï¼Œå¹¶ä¸”åˆ‡æ¢åˆ°å†…æ ¸æ ˆ
   - æ ¹æ®IDTæŸ¥è¯¢åˆ°å¯¹åº”page faultçš„ISRè·³è½¬åˆ°å¯¹åº”ISRæ‰§è¡Œï¼Œä¹‹åç”±è½¯ä»¶è¿›è¡Œå¯¹Page  Fault çš„å¤„ç†

## ç»ƒä¹ ä¸‰

> **é‡Šæ”¾æŸè™šåœ°å€æ‰€åœ¨çš„é¡µå¹¶å–æ¶ˆå¯¹åº”äºŒçº§é¡µè¡¨é¡¹çš„æ˜ å°„ï¼ˆéœ€è¦ç¼–ç¨‹ï¼‰**
>
> å½“é‡Šæ”¾ä¸€ä¸ªåŒ…å«æŸè™šåœ°å€çš„ç‰©ç†å†…å­˜é¡µæ—¶ï¼Œéœ€è¦è®©å¯¹åº”æ­¤ç‰©ç†å†…å­˜é¡µçš„ç®¡ç†æ•°æ®ç»“æ„Pageåšç›¸å…³çš„æ¸…é™¤å¤„ç†ï¼Œä½¿å¾—æ­¤ç‰©ç†å†…å­˜é¡µæˆä¸ºç©ºé—²ï¼›å¦å¤–è¿˜éœ€æŠŠè¡¨ç¤ºè™šåœ°å€ä¸ç‰©ç†åœ°å€å¯¹åº”å…³ç³»çš„äºŒçº§é¡µè¡¨é¡¹æ¸…é™¤ã€‚è¯·ä»”ç»†æŸ¥çœ‹å’Œç†è§£page_remove_pteå‡½æ•°ä¸­çš„æ³¨é‡Šã€‚ä¸ºæ­¤ï¼Œéœ€è¦è¡¥å…¨åœ¨ kern/mm/pmm.cä¸­çš„page_remove_pteå‡½æ•°ã€‚

â€‹	page_remove_pteå‡½æ•°çš„åŠŸèƒ½æ˜¯é‡Šæ”¾ä¸laå¯¹åº”paç›¸å…³çš„Pageï¼Œå¹¶clearä¸ä¹‹ç›¸å…³çš„pteä½¿å…¶æ— æ•ˆ

â€‹	é˜…è¯»æ³¨é‡Šç»™å‡ºçš„å®åŠå…¶å®šä¹‰

```c
//å® OR å‡½æ•°
struct Page *page pte2page(*ptep) // ä»ptepå€¼ä¸­è·å–ç›¸åº”çš„Pageç»“æ„ /kern/mm/pmm.h
free_page//é‡Šæ”¾ä¸€ä¸ªé¡µ  /kern/mm/pmm.h
page_ref_dec(page)//å‡å°‘è¯¥é¡µçš„å¼•ç”¨æ¬¡æ•°ï¼Œè¿”å›å‰©ä¸‹çš„å¼•ç”¨æ¬¡æ•° /kern/mm/pmm.h
tlb_invalidate(pde_t *pgdir, uintptr_t la)//å½“ä¿®æ”¹çš„é¡µè¡¨ç›®å‰æ­£åœ¨è¢«è¿›ç¨‹ä½¿ç”¨æ—¶ï¼Œä½¿ä¹‹æ— æ•ˆ  /kern/mm/pmm.h
//define
PTE_P 0x001 //è¡¨ç¤ºç‰©ç†å†…å­˜é¡µå­˜åœ¨
```

â€‹	æ­¥éª¤ï¼šâ‘ å°†ç‰©ç†é¡µçš„å¼•ç”¨æ•°ç›®å‡ä¸€ï¼Œè‹¥ä¸ºé›¶ï¼Œè¯´æ˜ä¸€çº§åªå¼•ç”¨äº†ä¸€æ¬¡ç›´æ¥é‡Šæ”¾â‘¡å°†é¡µDirectoryé¡¹æ¸…é›¶â‘¢åˆ·æ–°TLBã€‚

<img src="/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-9.png" alt="lab2-9" style="zoom:33%;" />

#### å›ç­”é—®é¢˜

> 1. æ•°æ®ç»“æ„Pageçš„å…¨å±€å˜é‡ï¼ˆå…¶å®æ˜¯ä¸€ä¸ªæ•°ç»„ï¼‰çš„æ¯ä¸€é¡¹ä¸é¡µè¡¨ä¸­çš„é¡µç›®å½•é¡¹å’Œé¡µè¡¨é¡¹æœ‰æ— å¯¹åº”å…³ç³»ï¼Ÿå¦‚æœæœ‰ï¼Œå…¶å¯¹åº”å…³ç³»æ˜¯å•¥ï¼Ÿ
> 2. å¦‚æœå¸Œæœ›è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ç›¸ç­‰ï¼Œåˆ™éœ€è¦å¦‚ä½•ä¿®æ”¹lab2ï¼Œå®Œæˆæ­¤äº‹ï¼Ÿ **é¼“åŠ±é€šè¿‡ç¼–ç¨‹æ¥å…·ä½“å®Œæˆè¿™ä¸ªé—®é¢˜**

1. å­˜åœ¨å¯¹åº”å…³ç³»ï¼šé¡µç›®å½•æˆ–é¡µè¡¨é¡¹ä¸­å­˜æ”¾ç€å¯¹åº”çš„ç‰©ç†é¡µçš„ç‰©ç†åœ°å€ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªç‰©ç†åœ°å€æ¥è·å–å¯¹åº”çš„Pageæ•°ç»„çš„å¯¹åº”é¡¹ï¼Œå…·ä½“åšæ³•ä¸ºå°†ç‰©ç†åœ°å€é™¤ä»¥ä¸€ä¸ªé¡µçš„å¤§å°ï¼Œç„¶åä¹˜ä¸Šä¸€ä¸ªPageç»“æ„çš„å¤§å°è·å¾—åç§»é‡ï¼Œä½¿ç”¨åç§»é‡åŠ ä¸ŠPageæ•°ç»„çš„åŸºåœ°å€å³å¯å¾—åˆ°å¯¹åº”Pageé¡¹çš„åœ°å€

2. é˜…è¯»å®éªŒå‚è€ƒä¹¦â€œç³»ç»Ÿæ‰§è¡Œä¸­åœ°å€æ˜ å°„çš„å››ä¸ªé˜¶æ®µâ€

   ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€ä¹‹é—´å­˜åœ¨åç§»é‡

   ç‰©ç†åœ°å€ + KERNBASE(0xC0000000) = è™šæ‹Ÿåœ°å€=çº¿æ€§åœ°å€

   æ‰€ä»¥ï¼ŒKERNBASE = 0æ—¶ï¼Œç‰©ç†åœ°å€ = è™šæ‹Ÿåœ°å€ï¼ŒæŠŠmemlayout.hä¸­æ”¹ä¸º

![lab2-10](/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-10.png)

â€‹	å¹¶æŒ‰ç…§lab1ä¿®æ”¹tools/kernel.ldä¸º

```c
SECTIONS {
    /* Load the kernel at this address: "." means the current address */
    . = 0x100000;//åŸæ¥æ˜¯0xC0100000
...
```

â€‹	æ³¨é‡Šæ‰kern/mm/pmm.cä¸­è¿™ä¸€éƒ¨åˆ†ä»£ç 

```
//disable the map of virtual_addr 0~4M
// boot_pgdir[0] = 0;

//now the basic virtual memory map(see memalyout.h) is established.
//check the correctness of the basic virtual memory map.
// check_boot_pgdir();
```

ä»£ç æ›´æ”¹å®Œæ¯•ååˆ†åˆ«æ‰§è¡Œ`make grade` `make qemu  ` å¾—åˆ°ä¸‹åˆ—ç»“æœ

<img src="/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-13.jpg" alt="lab2-11" style="zoom:30%;" />

<img src="/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-12.png" alt="lab2-11" style="zoom:40%;" />

## Challenge 1 ä¼™ä¼´ç³»ç»Ÿåˆ†é…ç®—æ³•

â€‹	é¦–å…ˆå‚è€ƒ[ä¼™ä¼´åˆ†é…å™¨çš„æç®€å®ç°](http://coolshell.cn/articles/10427.html)ä»¥åŠ[wuwenbin](https://github.com/wuwenbin)çš„ä»£ç 

> ä¼™ä¼´åˆ†é…çš„å®è´¨å°±æ˜¯ä¸€ç§ç‰¹æ®Šçš„â€œåˆ†ç¦»é€‚é…â€ï¼Œå³å°†å†…å­˜æŒ‰2çš„å¹‚è¿›è¡Œåˆ’åˆ†ï¼Œç›¸å½“äºåˆ†ç¦»å‡ºè‹¥å¹²ä¸ªå—å¤§å°ä¸€è‡´çš„ç©ºé—²é“¾è¡¨ï¼Œæœç´¢è¯¥é“¾è¡¨å¹¶ç»™å‡ºåŒéœ€æ±‚æœ€ä½³åŒ¹é…çš„å¤§å°ã€‚

â€‹	æ•´ä¸ªç®—æ³•å¤§ä½“ä¸Šå¯ä»¥è¡¨ç¤ºä¸ºï¼š

> **åˆ†é…å†…å­˜ï¼š**
> å¯»æ‰¾å¤§å°åˆé€‚çš„å†…å­˜å—ï¼ˆå¤§äºç­‰äºæ‰€éœ€å¤§å°å¹¶ä¸”æœ€æ¥è¿‘2çš„å¹‚ï¼Œæ¯”å¦‚éœ€è¦27ï¼Œå®é™…åˆ†é…32ï¼‰
>
> 1. å¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ†é…ç»™åº”ç”¨ç¨‹åºã€‚
> 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåˆ†å‡ºåˆé€‚çš„å†…å­˜å—ã€‚
>    1. å¯¹åŠåˆ†ç¦»å‡ºé«˜äºæ‰€éœ€å¤§å°çš„ç©ºé—²å†…å­˜å—
>    2. .å¦‚æœåˆ†åˆ°æœ€ä½é™åº¦ï¼Œåˆ†é…è¿™ä¸ªå¤§å°ã€‚
>    3. å›æº¯åˆ°æ­¥éª¤1ï¼ˆå¯»æ‰¾åˆé€‚å¤§å°çš„å—ï¼‰
>    4. é‡å¤è¯¥æ­¥éª¤ç›´åˆ°ä¸€ä¸ªåˆé€‚çš„å—
>
> **é‡Šæ”¾å†…å­˜ï¼š**
>
> é‡Šæ”¾è¯¥å†…å­˜å—
>
> 1. å¯»æ‰¾ç›¸é‚»çš„å—ï¼Œçœ‹å…¶æ˜¯å¦é‡Šæ”¾äº†ã€‚
> 2. å¦‚æœç›¸é‚»å—ä¹Ÿé‡Šæ”¾äº†ï¼Œåˆå¹¶è¿™ä¸¤ä¸ªå—ï¼Œé‡å¤ä¸Šè¿°æ­¥éª¤ç›´åˆ°é‡ä¸Šæœªé‡Šæ”¾çš„ç›¸é‚»å—ï¼Œæˆ–è€…è¾¾åˆ°æœ€é«˜ä¸Šé™ï¼ˆå³æ‰€æœ‰å†…å­˜éƒ½é‡Šæ”¾äº†ï¼‰ã€‚
>
> > å†ç»“åˆOSMOOCçš„ç¤ºæ„å›¾å¯ä»¥å¾ˆå¥½çš„ç†è§£ä¼™ä¼´ç³»ç»Ÿçš„ç®—æ³•å®ç°æ€è·¯

â€‹	**åˆ†é…å™¨çš„æ•´ä½“æ€æƒ³**

> é€šè¿‡ä¸€ä¸ªæ•°ç»„å½¢å¼çš„å®Œå…¨äºŒå‰æ ‘æ¥ç›‘æ§ç®¡ç†å†…å­˜ï¼ŒäºŒå‰æ ‘çš„èŠ‚ç‚¹ç”¨äºæ ‡è®°ç›¸åº”å†…å­˜å—çš„ä½¿ç”¨çŠ¶æ€ï¼Œé«˜å±‚èŠ‚ç‚¹å¯¹åº”å¤§çš„å—ï¼Œä½å±‚èŠ‚ç‚¹å¯¹åº”å°çš„å—ï¼Œåœ¨åˆ†é…å’Œé‡Šæ”¾ä¸­æˆ‘ä»¬å°±é€šè¿‡è¿™äº›èŠ‚ç‚¹çš„æ ‡è®°å±æ€§æ¥è¿›è¡Œå—çš„åˆ†ç¦»åˆå¹¶ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œå‡è®¾æ€»å¤§å°ä¸º16å•ä½çš„å†…å­˜ï¼Œæˆ‘ä»¬å°±å»ºç«‹ä¸€ä¸ªæ·±åº¦ä¸º5çš„æ»¡äºŒå‰æ ‘ï¼Œæ ¹èŠ‚ç‚¹ä»æ•°ç»„ä¸‹æ ‡[0]å¼€å§‹ï¼Œç›‘æ§å¤§å°16çš„å—ï¼›å®ƒçš„å·¦å³å­©å­èŠ‚ç‚¹ä¸‹æ ‡[1\]\[2]ï¼Œç›‘æ§å¤§å°8çš„å—ï¼›ç¬¬ä¸‰å±‚èŠ‚ç‚¹ä¸‹æ ‡[3\]\[6]ç›‘æ§å¤§å°4çš„å—â€¦â€¦ä¾æ­¤ç±»æ¨ã€‚

![lab2-14](/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-14.jpeg)

â€‹	æœ€ååœ¨[wuwenbin](https://github.com/wuwenbin/buddy2)ä»£ç çš„åŸºç¡€ä¸Šæ›´æ”¹å¤„é€‚ç”¨äºucoreçš„buddy system

â€‹	å‚ç…§default_pmm.hç»“åˆbuddy2.hå®ç°buddy.h

![lab2-15](/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-15.png)

â€‹	å‚ç…§default_pmm.cbuddy2.cå®ç°buddy.hå¹¶åœ¨å…¶ä¸­ä¿®æ”¹å†™æˆcheckå‡½æ•°ï¼Œä»£ç å¦‚ä¸‹



â€‹	`make qemu`ç»“æœå¦‚ä¸‹

â€‹	![lab2-16](/Users/zhouchenfei/Desktop/OSæˆªå›¾/lab2-16.png)

â€‹	

## Challenge 2 ä»»æ„å¤§å°çš„å†…å­˜å•å…ƒslubåˆ†é…ç®—æ³•

> å¤ªå¤æ‚äº†æ²¡çœ‹æ‡‚ä¹Ÿçœ‹ä¸ä¸‹å»äº†ï¼Œæ‰€ä»¥å¤§æ¦‚å¯èƒ½åšå®Œæ‰€æœ‰çš„è¿˜æœ‰ç©ºä¼šå›æ¥çœ‹çœ‹ğŸ‘€å§